networks:
  chatsystem-overlay:
    driver: overlay
    attachable: true

# 所有中间件数据都使用本地目录绑定，不再使用 Docker volume
# 数据存储在 ./docker_image_data/ 目录下

services:
  # ========== 基础设施服务 ==========

  etcd:
    image: quay.io/coreos/etcd:v3.5.9
    container_name: etcd
    hostname: etcd
    networks:
      - chatsystem-overlay
    ports:
      - "2379:2379"
      - "2380:2380"
    volumes:
      - ./docker_image_data/etcd:/etcd-data
    environment:
      - ETCD_NAME=etcd-node
      - ETCD_DATA_DIR=/etcd-data
      - ETCD_LISTEN_CLIENT_URLS=http://0.0.0.0:2379
      - ETCD_ADVERTISE_CLIENT_URLS=http://etcd:2379
      - ETCD_LISTEN_PEER_URLS=http://0.0.0.0:2380
      - ETCD_INITIAL_ADVERTISE_PEER_URLS=http://etcd:2380
      - ETCD_INITIAL_CLUSTER=etcd-node=http://etcd:2380
      - ETCD_INITIAL_CLUSTER_STATE=new
      - ETCD_INITIAL_CLUSTER_TOKEN=etcd-cluster
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      placement:
        constraints:
          - node.role == manager
    healthcheck:
      test: [ "CMD", "etcdctl", "endpoint", "health" ]
      interval: 10s
      timeout: 5s
      retries: 5

  mysql:
    image: mysql:8.0
    container_name: mysql
    hostname: mysql
    networks:
      - chatsystem-overlay
    ports:
      - "3306:3306"
    volumes:
      - ./docker_image_data/mysql:/var/lib/mysql
      - ./SQL_Code/init_all.sql:/docker-entrypoint-initdb.d/init.sql:ro
    environment:
      - MYSQL_ROOT_PASSWORD=Cydia4384!
      - MYSQL_DATABASE=chen_im
      - MYSQL_CHARACTER_SET_SERVER=utf8mb4
      - MYSQL_COLLATION_SERVER=utf8mb4_unicode_ci
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-pCydia4384!" ]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: redis
    hostname: redis
    networks:
      - chatsystem-overlay
    ports:
      - "6379:6379"
    volumes:
      - ./docker_image_data/redis:/data
    command: redis-server --appendonly yes
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 3s
      retries: 5

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: elasticsearch
    hostname: elasticsearch
    networks:
      - chatsystem-overlay
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - ./docker_image_data/elasticsearch:/usr/share/elasticsearch/data
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      # 降低 JVM 内存以适配主机资源
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
      resources:
        limits:
          memory: 1G
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5

  rabbitmq:
    image: rabbitmq:3.12-management-alpine
    container_name: rabbitmq
    hostname: rabbitmq
    networks:
      - chatsystem-overlay
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - ./docker_image_data/rabbitmq:/var/lib/rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=root
      - RABBITMQ_DEFAULT_PASS=czhuowen
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ========== 业务服务 ==========

  speech_server:
    build:
      context: ./1.Speech_Server
      dockerfile: Dockerfile
    image: speech_server:v3
    networks:
      - chatsystem-overlay
    volumes:
      - ./Configs/speech_server.conf:/im/conf/speech_server.conf:ro
      - ./docker_image_data/logs:/im/logs:rw
      - ./docker_image_data/data:/im/data:rw
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    depends_on:
      etcd:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 10001 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3

  file_server:
    build:
      context: ./2.File_Server
      dockerfile: Dockerfile
    image: file_server:v3
    networks:
      - chatsystem-overlay
    volumes:
      - ./Configs/file_server.conf:/im/conf/file_server.conf:ro
      - ./docker_image_data/logs:/im/logs:rw
      - ./docker_image_data/data:/im/data:rw
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    depends_on:
      etcd:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 10002 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3

  user_server:
    build:
      context: ./3.User_Server
      dockerfile: Dockerfile
    image: user_server:v3
    networks:
      - chatsystem-overlay
    volumes:
      - ./Configs/user_server.conf:/im/conf/user_server.conf:ro
      - ./docker_image_data/logs:/im/logs:rw
    environment:
      - ES_HOST=http://elasticsearch:9200
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    depends_on:
      etcd:
        condition: service_healthy
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 10003 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3

  message_transmit_server:
    build:
      context: ./4.Message_Transmit_Server
      dockerfile: Dockerfile
    image: message_transmit_server:v3
    networks:
      - chatsystem-overlay
    volumes:
      - ./Configs/message_transmit_server.conf:/im/conf/message_transmit_server.conf:ro
      - ./docker_image_data/logs:/im/logs:rw
      - ./docker_image_data/data:/im/data:rw
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    depends_on:
      etcd:
        condition: service_healthy
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 10004 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3

  message_store_server:
    build:
      context: ./5.Message_Store_Server
      dockerfile: Dockerfile
    image: message_store_server:v3
    networks:
      - chatsystem-overlay
    volumes:
      - ./Configs/message_store_server.conf:/im/conf/message_store_server.conf:ro
      - ./docker_image_data/logs:/im/logs:rw
      - ./docker_image_data/data:/im/data:rw
    environment:
      - ES_HOST=http://elasticsearch:9200
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    depends_on:
      etcd:
        condition: service_healthy
      mysql:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 10005 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3

  friend_server:
    build:
      context: ./6.Friend_Server
      dockerfile: Dockerfile
    image: friend_server:v3
    networks:
      - chatsystem-overlay
    volumes:
      - ./Configs/friend_server.conf:/im/conf/friend_server.conf:ro
      - ./docker_image_data/logs:/im/logs:rw
      - ./docker_image_data/data:/im/data:rw
    environment:
      - ES_HOST=http://elasticsearch:9200
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    depends_on:
      etcd:
        condition: service_healthy
      mysql:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 10006 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3

  agent_server:
    build:
      context: ..
      dockerfile: ChatSystem-Backend/8.Agent_Server/Dockerfile
    image: agent_server:v1
    container_name: agent_server
    hostname: agent_server
    networks:
      - chatsystem-overlay
    ports:
      - "8080:8080"
    environment:
      - MYSQL_HOST=mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=Cydia4384!
      - MYSQL_DATABASE=chen_im
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - HOST=0.0.0.0
      - PORT=8080
      - DEBUG=false
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8080/health')\" || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3

  gateway_server:
    build:
      context: ./7.Gateway_Server
      dockerfile: Dockerfile
    image: gateway_server:v3
    networks:
      - chatsystem-overlay
    # Linux Docker：host.docker.internal 用于兼容宿主机上的其他服务
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - ./Configs/gateway_server_docker.conf:/im/conf/gateway_server.conf:ro
      - ./docker_image_data/logs:/im/logs:rw
      - ./docker_image_data/data:/im/data:rw
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    depends_on:
      etcd:
        condition: service_healthy
      redis:
        condition: service_healthy
      agent_server:
        condition: service_healthy
      speech_server:
        condition: service_healthy
      file_server:
        condition: service_healthy
      user_server:
        condition: service_healthy
      message_transmit_server:
        condition: service_healthy
      message_store_server:
        condition: service_healthy
      friend_server:
        condition: service_healthy
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 9000 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 3
