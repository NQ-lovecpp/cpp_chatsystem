<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Server æµ‹è¯•é¡µé¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .event-log {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        .event-init { color: #10b981; }
        .event-reasoning_delta { color: #8b5cf6; }
        .event-message { color: #3b82f6; }
        .event-tool_call { color: #f59e0b; }
        .event-tool_output { color: #06b6d4; }
        .event-todo_added { color: #ec4899; }
        .event-todo_status { color: #ec4899; }
        .event-interruption { color: #ef4444; font-weight: bold; }
        .event-approval_resolved { color: #22c55e; }
        .event-done { color: #22c55e; }
        .event-error { color: #ef4444; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Agent Server æµ‹è¯•é¢æ¿</h1>
        <p class="text-gray-600 mb-6">Phase 2: å·¥å…·è°ƒç”¨æµ‹è¯• (web_search, python_execute)</p>

        <!-- æœåŠ¡çŠ¶æ€ -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold">æœåŠ¡çŠ¶æ€</h2>
                <button onclick="checkStatus()" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                    åˆ·æ–°çŠ¶æ€
                </button>
            </div>
            <div id="status" class="mt-3 p-3 bg-gray-50 rounded text-sm">
                ç‚¹å‡»"åˆ·æ–°çŠ¶æ€"æ£€æŸ¥æœåŠ¡
            </div>
        </div>

        <!-- å¿«æ·æµ‹è¯• -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h2 class="text-lg font-semibold mb-4">å¿«æ·æµ‹è¯•</h2>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="quickTest('æœç´¢ Python async await æ•™ç¨‹')" 
                        class="px-4 py-2 bg-amber-500 text-white rounded hover:bg-amber-600">
                    ğŸ” æµ‹è¯•æœç´¢
                </button>
                <button onclick="quickTest('è®¡ç®— 1+2+3+...+100 çš„å’Œ')" 
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                    ğŸ æµ‹è¯• Python
                </button>
                <button onclick="quickTest('ä½ å¥½ï¼Œä»‹ç»ä¸€ä¸‹ä½ çš„åŠŸèƒ½')" 
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    ğŸ’¬ æ™®é€šå¯¹è¯
                </button>
                <button onclick="quickTest('æœç´¢ ChatGPT æœ€æ–°æ¶ˆæ¯')" 
                        class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                    ğŸŒ æœç´¢æ–°é—»
                </button>
            </div>
        </div>

        <!-- åˆ›å»ºä»»åŠ¡ -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <h2 class="text-lg font-semibold mb-4">åˆ›å»ºä»»åŠ¡</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ· ID</label>
                    <input type="text" id="userId" value="test_user" 
                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡ç±»å‹</label>
                    <select id="taskType" class="w-full px-3 py-2 border rounded-lg">
                        <option value="session">ä¼šè¯ä»»åŠ¡ (session)</option>
                        <option value="global">å…¨å±€ä»»åŠ¡ (global)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">è¾“å…¥å†…å®¹</label>
                    <textarea id="inputText" rows="3" 
                              class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                              placeholder="è¾“å…¥ä½ çš„é—®é¢˜æˆ–ä»»åŠ¡...">æœç´¢ Python FastAPI æ•™ç¨‹</textarea>
                </div>
                <button onclick="createTask()" 
                        class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 font-medium">
                    åˆ›å»ºä»»åŠ¡å¹¶è®¢é˜…äº‹ä»¶
                </button>
            </div>
        </div>

        <!-- å½“å‰ä»»åŠ¡ -->
        <div id="currentTask" class="bg-white rounded-lg shadow p-4 mb-6 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">å½“å‰ä»»åŠ¡</h2>
                <span id="taskStatus" class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800">-</span>
            </div>
            <div class="text-sm text-gray-600 mb-2">
                ä»»åŠ¡ ID: <code id="taskId" class="bg-gray-100 px-2 py-1 rounded">-</code>
            </div>
            <div class="flex space-x-2">
                <button onclick="cancelTask()" 
                        class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                    å–æ¶ˆä»»åŠ¡
                </button>
                <button onclick="getTaskDetail()" 
                        class="px-3 py-1 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm">
                    æŸ¥çœ‹è¯¦æƒ…
                </button>
            </div>
        </div>

        <!-- å®¡æ‰¹å¼¹çª— -->
        <div id="approvalModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full mx-4">
                <h3 class="text-lg font-semibold mb-4">âš ï¸ éœ€è¦æ‚¨çš„å®¡æ‰¹</h3>
                <div id="approvalContent" class="mb-4 p-3 bg-gray-50 rounded text-sm">
                    <!-- å®¡æ‰¹å†…å®¹ -->
                </div>
                <div class="flex space-x-3">
                    <button onclick="submitApproval(true)" 
                            class="flex-1 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        âœ… æ‰¹å‡†æ‰§è¡Œ
                    </button>
                    <button onclick="submitApproval(false)" 
                            class="flex-1 px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        âŒ æ‹’ç»
                    </button>
                </div>
            </div>
        </div>

        <!-- äº‹ä»¶æ—¥å¿— -->
        <div class="bg-white rounded-lg shadow p-4 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">SSE äº‹ä»¶æ—¥å¿—</h2>
                <button onclick="clearLog()" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm">
                    æ¸…ç©ºæ—¥å¿—
                </button>
            </div>
            <div id="eventLog" class="event-log bg-gray-900 text-gray-100 p-4 rounded-lg h-80 overflow-y-auto">
                <div class="text-gray-500">ç­‰å¾…äº‹ä»¶...</div>
            </div>
        </div>

        <!-- å“åº”å†…å®¹ -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="text-lg font-semibold mb-4">å“åº”å†…å®¹</h2>
            <div id="responseContent" class="prose max-w-none p-4 bg-gray-50 rounded-lg min-h-[100px] whitespace-pre-wrap">
                <p class="text-gray-400">ç­‰å¾…å“åº”...</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentTaskId = null;
        let currentApprovalId = null;
        let eventSource = null;
        let responseText = '';

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkStatus() {
            const statusDiv = document.getElementById('status');
            try {
                const res = await fetch(`${API_BASE}/agent/status`);
                const data = await res.json();
                
                const features = Object.entries(data.features || {})
                    .filter(([k, v]) => v)
                    .map(([k]) => k)
                    .join(', ');
                
                const tools = (data.tools || []).join(', ');
                
                let pythonStatus = 'æœªåˆå§‹åŒ–';
                if (data.python_executor) {
                    pythonStatus = data.python_executor.initialized 
                        ? `è¿è¡Œä¸­ (${data.python_executor.container_status})`
                        : 'æœªå¯åŠ¨';
                }
                
                statusDiv.innerHTML = `
                    <div class="text-green-600 font-medium">âœ… æœåŠ¡è¿è¡Œä¸­</div>
                    <div class="mt-2 text-gray-600 space-y-1">
                        <div>æ¨¡å‹: ${data.model}</div>
                        <div>åŠŸèƒ½: ${features}</div>
                        <div>å·¥å…·: ${tools}</div>
                        <div>Python æ‰§è¡Œå™¨: ${pythonStatus}</div>
                    </div>
                `;
            } catch (e) {
                statusDiv.innerHTML = `<div class="text-red-600">âŒ æœåŠ¡è¿æ¥å¤±è´¥: ${e.message}</div>`;
            }
        }

        // å¿«æ·æµ‹è¯•
        function quickTest(text) {
            document.getElementById('inputText').value = text;
            createTask();
        }

        // åˆ›å»ºä»»åŠ¡
        async function createTask() {
            const userId = document.getElementById('userId').value;
            const taskType = document.getElementById('taskType').value;
            const inputText = document.getElementById('inputText').value;

            if (!inputText.trim()) {
                alert('è¯·è¾“å…¥ä»»åŠ¡å†…å®¹');
                return;
            }

            // å…³é—­ä¹‹å‰çš„ SSE è¿æ¥
            if (eventSource) {
                eventSource.close();
            }

            // æ¸…ç©ºå“åº”
            responseText = '';
            document.getElementById('responseContent').innerHTML = '<p class="text-gray-400">ç­‰å¾…å“åº”...</p>';

            try {
                const res = await fetch(`${API_BASE}/agent/tasks?user_id=${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        input: inputText,
                        task_type: taskType
                    })
                });

                const data = await res.json();
                currentTaskId = data.task_id;

                // æ˜¾ç¤ºå½“å‰ä»»åŠ¡
                document.getElementById('currentTask').classList.remove('hidden');
                document.getElementById('taskId').textContent = currentTaskId;
                document.getElementById('taskStatus').textContent = data.status;
                document.getElementById('taskStatus').className = 'px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800';

                logEvent('task_created', { task_id: currentTaskId });

                // è®¢é˜… SSE
                subscribeEvents(currentTaskId, userId);

            } catch (e) {
                logEvent('error', { message: e.message });
            }
        }

        // è®¢é˜… SSE äº‹ä»¶
        function subscribeEvents(taskId, userId) {
            const url = `${API_BASE}/agent/events?task_id=${taskId}&user_id=${userId}`;
            eventSource = new EventSource(url);

            eventSource.onopen = () => {
                logEvent('sse_connected', { url });
            };

            eventSource.onerror = (e) => {
                logEvent('sse_error', { error: 'Connection error' });
            };

            // ç›‘å¬å„ç§äº‹ä»¶
            const eventTypes = ['init', 'reasoning_delta', 'message', 'tool_call', 'tool_output', 
                               'todo_added', 'todo_status', 'interruption', 'approval_resolved',
                               'done', 'error', 'task_created', 'task_status', 'task_cancelled'];
            
            eventTypes.forEach(type => {
                eventSource.addEventListener(type, (e) => {
                    const data = JSON.parse(e.data);
                    logEvent(type, data);

                    // å¤„ç†æ¶ˆæ¯å†…å®¹
                    if (type === 'message' && data.content) {
                        responseText += data.content;
                        updateResponse();
                    }

                    // å¤„ç†å·¥å…·è°ƒç”¨
                    if (type === 'tool_call') {
                        const toolInfo = `\nğŸ”§ è°ƒç”¨å·¥å…·: ${data.tool_name}\n`;
                        responseText += toolInfo;
                        updateResponse();
                    }

                    // å¤„ç†å·¥å…·è¾“å‡º
                    if (type === 'tool_output') {
                        // å·¥å…·ç»“æœä¼šåœ¨ message äº‹ä»¶ä¸­å±•ç¤º
                    }

                    // å¤„ç†å®¡æ‰¹è¯·æ±‚
                    if (type === 'interruption' && data.approval) {
                        currentApprovalId = data.approval.id;
                        showApprovalModal(data.approval);
                        document.getElementById('taskStatus').textContent = 'waiting_approval';
                        document.getElementById('taskStatus').className = 'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800';
                    }

                    // å¤„ç†å®¡æ‰¹ç»“æœ
                    if (type === 'approval_resolved') {
                        hideApprovalModal();
                        if (data.status === 'approved') {
                            document.getElementById('taskStatus').textContent = 'running';
                            document.getElementById('taskStatus').className = 'px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800';
                        }
                    }

                    // å¤„ç†å®Œæˆ
                    if (type === 'done') {
                        if (data.final_text) {
                            responseText = data.final_text;
                            updateResponse();
                        }
                        document.getElementById('taskStatus').textContent = 'done';
                        document.getElementById('taskStatus').className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
                        eventSource.close();
                    }

                    // å¤„ç†é”™è¯¯
                    if (type === 'error') {
                        document.getElementById('taskStatus').textContent = 'failed';
                        document.getElementById('taskStatus').className = 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-800';
                        eventSource.close();
                    }
                });
            });
        }

        // æ˜¾ç¤ºå®¡æ‰¹å¼¹çª—
        function showApprovalModal(approval) {
            const content = document.getElementById('approvalContent');
            content.innerHTML = `
                <div class="mb-2"><strong>å·¥å…·:</strong> ${approval.tool_name}</div>
                <div class="mb-2"><strong>åŸå› :</strong> ${approval.reason}</div>
                <div><strong>å‚æ•°:</strong></div>
                <pre class="mt-1 p-2 bg-gray-800 text-green-400 rounded text-xs overflow-auto max-h-40">${JSON.stringify(approval.tool_args, null, 2)}</pre>
            `;
            document.getElementById('approvalModal').classList.remove('hidden');
            document.getElementById('approvalModal').classList.add('flex');
        }

        // éšè—å®¡æ‰¹å¼¹çª—
        function hideApprovalModal() {
            document.getElementById('approvalModal').classList.add('hidden');
            document.getElementById('approvalModal').classList.remove('flex');
        }

        // æäº¤å®¡æ‰¹
        async function submitApproval(approved) {
            if (!currentApprovalId) return;
            
            const userId = document.getElementById('userId').value;
            try {
                const res = await fetch(`${API_BASE}/agent/approvals?user_id=${userId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        approval_id: currentApprovalId,
                        approved: approved
                    })
                });
                const data = await res.json();
                logEvent('approval_submitted', data);
                hideApprovalModal();
                currentApprovalId = null;
            } catch (e) {
                logEvent('error', { message: e.message });
            }
        }

        // æ›´æ–°å“åº”æ˜¾ç¤º
        function updateResponse() {
            const contentDiv = document.getElementById('responseContent');
            // ç®€å•çš„ Markdown æ¸²æŸ“
            let html = responseText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-800 text-green-400 p-2 rounded mt-2 mb-2 overflow-auto">$1</pre>')
                .replace(/`([^`]+)`/g, '<code class="bg-gray-200 px-1 rounded">$1</code>')
                .replace(/\n/g, '<br>');
            contentDiv.innerHTML = html || '<p class="text-gray-400">ç­‰å¾…å“åº”...</p>';
        }

        // è®°å½•äº‹ä»¶æ—¥å¿—
        function logEvent(type, data) {
            const logDiv = document.getElementById('eventLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = `event-${type} mb-1`;
            
            let dataStr = JSON.stringify(data);
            if (dataStr.length > 200) {
                dataStr = dataStr.substring(0, 200) + '...';
            }
            
            entry.innerHTML = `<span class="text-gray-500">[${time}]</span> <span class="font-bold">${type}</span>: ${dataStr}`;
            
            // ç§»é™¤å ä½ç¬¦
            if (logDiv.querySelector('.text-gray-500:only-child')) {
                logDiv.innerHTML = '';
            }
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLog() {
            document.getElementById('eventLog').innerHTML = '<div class="text-gray-500">ç­‰å¾…äº‹ä»¶...</div>';
            responseText = '';
            document.getElementById('responseContent').innerHTML = '<p class="text-gray-400">ç­‰å¾…å“åº”...</p>';
        }

        // å–æ¶ˆä»»åŠ¡
        async function cancelTask() {
            if (!currentTaskId) return;
            
            const userId = document.getElementById('userId').value;
            try {
                const res = await fetch(`${API_BASE}/agent/tasks/${currentTaskId}/cancel?user_id=${userId}`, {
                    method: 'POST'
                });
                const data = await res.json();
                logEvent('task_cancelled', data);
                document.getElementById('taskStatus').textContent = 'cancelled';
                document.getElementById('taskStatus').className = 'px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800';
            } catch (e) {
                logEvent('error', { message: e.message });
            }
        }

        // è·å–ä»»åŠ¡è¯¦æƒ…
        async function getTaskDetail() {
            if (!currentTaskId) return;
            
            const userId = document.getElementById('userId').value;
            try {
                const res = await fetch(`${API_BASE}/agent/tasks/${currentTaskId}?user_id=${userId}`);
                const data = await res.json();
                logEvent('task_detail', data);
            } catch (e) {
                logEvent('error', { message: e.message });
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
        window.onload = checkStatus;
    </script>
</body>
</html>
